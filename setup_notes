# as root:
useradd --system --user-group --shell /bin/bash --create-home --home /var/lib/certfetcher --comment 'pki certificate fetcher' certfetcher
groupadd local_pki
groupadd httpd_operators

usermod -aG local_pki certfetcher
usermod -aG httpd_operators certfetcher

# /etc/sudoers.d/90-local
%httpd_operators            ALL=(root)NOPASSWD:         /usr/sbin/service apache2 reload
chmod 0440 /etc/sudoers.d/90-local

mkdir -p /etc/pki/local
chmod 1775 /etc/pki/local
chgrp local_pki /etc/pki/local
cd /etc/pki/local
chgrp local_pki *
chmod g+r *

mkdir -p /etc/pki/intermediate_authorities/letsencrypt
cd /etc/pki/intermediate_authorities/letsencrypt
curl -kvL 'https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem' -o 'lets_encrypt_authority_x3-dst_root-cert.pem'
curl -kvL 'https://letsencrypt.org/certs/letsencryptauthorityx3.pem' -o 'lets_encrypt_authority_x3-isrg_root-cert.pem'

mkdir -p /opt/<foo>/bin
cd /opt/<foo>/bin
curl -vkLO 'https://raw.githubusercontent.com/junkb/cert_checker/master/cert_checker'
curl -vkLO 'https://raw.githubusercontent.com/junkb/cert_checker/master/cert_checker-cron'
curl -vkLO 'https://raw.githubusercontent.com/junkb/cert_checker/master/cert_checker-reload_prosody'
chmod +x cert*

mkdir -p /opt/acme-tiny
cd /opt/acme_tiny
curl -vkLO 'https://raw.githubusercontent.com/junkb/acme-tiny/master/acme-tiny-reqcert'
chmod +x acme*

mkdir -p /etc/pki/local/old
chgrp certfetcher /etc/pki/local/old
chmod g+w /etc/pki/local/old

temp_ts=$(date +%Y.%m.%d-%H.%M.%S)
mkdir -p "/etc/pki/local/old/${temp_ts}"

mkdir -p /srv/www/global/.well-known/acme-challenge
chown certfetcher.certfetcher /srv/www/global/.well-known/acme-challenge

# httpd config
# disable reverse proxying for the /.well-known uri.  this allows the letsencrypt
# mechanism to work properly
ProxyPass	/.well-known !

Alias /.well-known	/srv/www/global/.well-known

# initial key/csr creation:
export cert_name='www.example.com'; \
export dn_section='req_dn_short-no_prompt'; \
openssl req \
    -new \
    -out "${cert_name}-csr.pem"

chgrp local_pki "${cert_name}"*
touch "${cert_name}-cert.pem"
chown certfetcher.local_pki "${cert_name}-cert.pem"
chmod 'g+r' "${cert_name}"*

# as certfetcher:
mkdir -p ~/pki/verification_bundles/letsencrypt/dev
mkdir -p ~/pki/verification_bundles/letsencrypt/prod

cd ~/pki/verification_bundles/letsencrypt/prod
ln -s /etc/pki/intermediate_authorities/letsencrypt/lets_encrypt_authority_x3-dst_root-cert.pem
ln -s /etc/pki/trusted_root_authorities/DST_Root_CA_X3.pem
for file in *; do ln -s "${file}" $(openssl x509 -noout -hash < "${file}").0; done

cd ~/pki/verification_bundles/letsencrypt/dev
curl -vkL 'https://letsencrypt.org/certs/fakeleintermediatex1.pem' -o fake_le_intermediate_x1-cert.pem
curl -vkL 'https://letsencrypt.org/certs/fakelerootx1.pem' -o fake_le_root_x1-cert.pem
for file in *; do ln -s "${file}" $(openssl x509 -noout -hash < "${file}").0; done

mkdir -p ~/.config/cert_checker
cd ~/.config/cert_checker
curl -vkLO 'https://raw.githubusercontent.com/junkb/cert_checker/master/.config/cert_checker/cert_checker.conf'
curl -vkLO 'https://raw.githubusercontent.com/junkb/cert_checker/master/.config/cert_checker/cert_checker.hosts'
curl -vkLO 'https://raw.githubusercontent.com/junkb/cert_checker/master/.config/cert_checker/cert_checker.services'

cd ~/pki
chmod 0600 *private*

export cert_name='www.example.com'; \
acme-tiny-reqcert \
  --ca 'https://acme-v01.api.letsencrypt.org' \
  --account-key ~/pki/letsencrypt_account-<Foo>-key-rsa-private.pem \
  --csr "/etc/pki/local/${cert_name}-csr.pem" \
  --acme-dir /srv/www/global/.well-known/acme-challenge \
  > "/etc/pki/local/${cert_name}-cert.pem"

crontab -lu certfetcher
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/<foo>/bin:/opt/acme-tiny
MAILTO='pki_monitoring@example.com'

# every day, at 04.00
# update any certificates which are expiring soon
0	4	*	*	*			cert_checker-cron
